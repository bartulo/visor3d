<!DOCTYPE html>
<html lang="en">
	<head>
		<title>three.js webgl - lines - fat</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<script src="js/jquery-2.1.4.js"></script> 
		
		<script src="js/bootstrap.min.js"></script>
		<script src="js/threejs/three.js"></script>
		<script src="js/threejs/controls/OrbitControls.js"></script>

		<script src="js/threejs/Detector.js"></script>
		<script src='js/threejs/TerrainLoader.js'></script> 

		<script src='js/lines/LineSegmentsGeometry.js'></script>
		<script src='js/lines/LineGeometry.js'></script>
		<script src='js/lines/WireframeGeometry2.js'></script>

		<script src='js/lines/LineMaterial.js'></script>

		<script src='js/lines/LineSegments2.js'></script>
		<script src='js/lines/Line2.js'></script>
		<script src='js/lines/Wireframe.js'></script>
		<link rel="stylesheet" type="text/css" href="css/bootstrap.css"> 
		<link rel="stylesheet" type="text/css" href="css/main.css"> 

	</head>

	<body>

		<div id="container">
			<ul class='tabs'>
				<li>PINTAR</li>
				<li>MEDIR</li>
				<li>ICONOS</li>
				<li>IMAGEN</li>
			</ul>
			<div id="sidebar">
				<ul class="tab_content">
					<li>
						<div class="content_wrapper">
							<h2 class="text-color">Elige un color:</h2>
						
							<ul class="colors">
								<li data-color="#00b0f0"></li>
								<li data-color="#ff0000"></li>
								<li data-color="#92d050"></li>
								<li class="active-color" data-color="#fa7e5c"></li>
								<li data-color="#000000"></li>
								<li data-color="#fab8f2"></li>
								<li data-color="#944607"></li>
							</ul>
							<div class="slide_wrapper">
								<input id="sliderColor" type="range" min="4" max="20" step="1" value="8"/>
							</div>
							<div class="lines_wrapper">
								<ul class="lines"></ul>
							</div>
							<a href="" id="download" download="canvasexport.png">Descargar</a>
							<div class="button_wrapper">
								<button type="button" class="btn btn-danger stop">Dejar de pintar</button>
							</div>
						</div>
					</li>
					
					<li>
						<div class="content_wrapper">
							<h2 class="text-color">Medir</h2>
							<div class="medicion"></div>
							<div class="button_wrapper">
								<button type="button" class="btn btn-danger stop">Dejar de medir</button>
							</div>
						</div>
					</li>
					
					<li>
						<div class="content_wrapper">
							<h2 class="text-color">Iconos</h2>
							<div class="button_wrapper">
								<button type="button" class="btn btn-danger stop">Volver</button>
							</div>
						</div>
					</li>
					
					<li>
						<div class="content_wrapper">
							<h2 class="text-color">Guardar Imagen</h2>
							<div class="button_wrapper">
								<button type="button" class="btn btn-danger stop">Volver</button>
								<button type="button" class="btn" id="saveImg">Guardar Imagen</button>
							</div>
						</div>
					</li>
					
				</ul>
			</div>
		</div>

		
		<script id="fragment_shh" type="x-shader/x-fragment">
			#ifdef GL_ES
			precision highp float;
			#endif

			uniform sampler2D tOne;
			uniform sampler2D tSec;

			varying vec2 vUv;
			
			void main(void)
			{
				vec3 c;
				vec4 Ca = texture2D(tOne, vUv);
				vec4 Cb = texture2D(tSec, vUv);
				c = Ca.rgb * Ca.a + Cb.rgb * Cb.a * (1.0 - Ca.a);
			    gl_FragColor= vec4(c, 1.0);
				
			}
			
		</script>
		<script id="vertex_shh" type="x-shader/x-vertex">
		
			varying vec2 vUv;
			
			void main()
			{
				vUv = uv;
				vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );
				gl_Position = projectionMatrix * mvPosition;
			}
			
		</script>

		<script>
			

			if ( ! Detector.webgl ) Detector.addGetWebGLMessage();

			var wireframe, renderer, scene, camera, controls;
			var plane, wireframe1, geometryLine, medir, pos;
			var positions = [];
			var colors = [];
			var group = new THREE.Object3D();
			var a = -1;
			var b = 0;
			var count = 0;
			var altitud = [];
			var alt;
			var colorButton = $(".colors li");
			var color = '#fa7e5c';
			var grosor = 4;
			var interval;
			
			// viewport

			init();
			animate();
			
			$( document ).ready( function() {
				console.log( $('.tabs >li').length );
				for ( i = 0; i < $('.tabs >li').length; i++) {
					tabTop = 30 + ( i * 110);
					$('.tabs >li')[i].style.top = tabTop + 'px' ;
				}
			});
			
			function hexToRgbA(hex){
			var c;
			if(/^#([A-Fa-f0-9]{3}){1,2}$/.test(hex)){
				c= hex.substring(1).split('');
				if(c.length== 3){
					c= [c[0], c[0], c[1], c[1], c[2], c[2]];
				}
				c= '0x'+c.join('');
				return [((c>>16)&255)/255, ((c>>8)&255)/255, (c&255)/255];
			}
			throw new Error('Bad Hex');
			}
			
			function closeTab(index) {
				$('#sidebar')[0].style.marginLeft = '-310px'; 
				$('.tabs > li').css('left', '-10px');
				$('.tab_content >li').eq( index ).hide();
				$(".tabs >li").removeClass('active');
				a = -1;
			}
				
			function openTab() {
				$('#sidebar')[0].style.marginLeft = '0px'; 
				$('.tabs > li').css('left', '300px');
			}
			
			$(".stop").on( "click", function() {
				closeTab(a);
			});
			
			$(".tabs > li").on( "click", function() {
					
				var index = $(this).index();

				if ( a == -1 ) {
					
					$(this).addClass('active');
					
					$('.tab_content >li').eq(index).show();
					
					a = index;
					
					openTab();
					
				} else {
					
					if (index == a) {
						
						$(".tabs >li").removeClass('active');
						
						closeTab();
						
						a = -1;
						
						$('.tab_content >li').eq(index).hide();

					} else {
						
						$(".tabs >li").removeClass('active');

						$(this).addClass('active');
					
						$('.tab_content >li').eq(a).hide();

						$('.tab_content >li').eq(index).show();
						
						a = index;
					}
						
			}});
			
			function eraseLine( event ) {
				var index = $(event.target.parentElement).index();
						
				clearInterval( interval );
		
				$('.lines >li')[index].remove();
				
				group.remove(group.children[index]);
				
			}
			
			function hoverLine( event ) {
				if ( event.target.tagName === 'LI' ) {
				
					var index = $(event.target).index();
					
				} else if ( event.target.tagName === 'BUTTON' ) {
				
					var index = $(event.target.parentElement).index();
					
				}
				
				//~ group.children[index].material.visible = true;

				interval = setInterval( function() {
					if ( group.children[index].material.visible ) {
						console.log('true');
						
						group.children[index].material.visible = false;
						
					} else {
						console.log('false');
						
						group.children[index].material.visible = true;
					}
				}, 160);
				
				console.log( interval );
						
			}
			
			function unhoverLine( event ) {
				if ( event.target.tagName === 'LI' ) {
				
					var index = $(event.target).index();
					
				} else if ( event.target.tagName === 'BUTTON' ) {
				
					var index = $(event.target.parentElement).index();
					
				}
				
				clearInterval( interval );
				
				group.children[index].material.visible = true;
			}
				
			colorButton.on("click", function(){
		
				// Remove class from currently active button
				$(".colors > li").removeClass("active-color");
		
				// Add class active to clicked button
				$(this).addClass("active-color");
		
				// Get background color of clicked
				color = $(this).attr("data-color");
			});	
			
			$('#sliderColor').on('change', function() {
				grosor = this.value;
			});
			
			$('#saveImg').on('click', function() {
				
				var canvas = renderer.domElement;
				
				var imgData = canvas.toDataURL('image/jpeg');
				
				var imgLink = document.createElement('a');
				
				document.body.appendChild(imgLink);
				
				imgLink.download = 'prueba.jpg';
				
				imgLink.href = imgData.replace('image/jpeg', 'image/octet-stream');
				
				imgLink.click();
				
				document.body.removeChild(imgLink);
				
			});
								

			function init() {

				renderer = new THREE.WebGLRenderer( { antialias: true, preserveDrawingBuffer: true  } );
				renderer.setPixelRatio( window.devicePixelRatio );
				renderer.setClearColor( 0x000000, 0.0 );
				renderer.setSize( window.innerWidth, window.innerHeight );
				document.getElementById('container').appendChild( renderer.domElement );

				scene = new THREE.Scene();
				scene.add(group);

				camera = new THREE.PerspectiveCamera( 45, window.innerWidth / window.innerHeight, 0.1, 1000 );
				camera.position.set( 0, -90, 200 );

				controls = new THREE.OrbitControls( camera, renderer.domElement );
				controls.minDistance = 0;
				controls.maxDistance = 500;
				
				//PLANO
				
				var terrainLoader = new THREE.TerrainLoader();
				terrainLoader.load('images/mdt.bin', function(data) {

					var vertShader = document.getElementById('vertex_shh').innerHTML;
					var fragShader = document.getElementById('fragment_shh').innerHTML;
			
					var uniforms = {    // custom uniforms (your textures)

					tOne: { type: "t", value: THREE.ImageUtils.loadTexture( 'images/E2.png') },
					tSec: { type: "t", value: THREE.ImageUtils.loadTexture( 'images/pnoa.jpg' ) }
					};
					
					var material_shh = new THREE.ShaderMaterial({
						uniforms: uniforms,
						vertexShader: vertShader,
						fragmentShader: fragShader
					});
				
					var geometry = new THREE.PlaneGeometry(300, 300, 199, 199);
			
					for (var i = 0, l = geometry.vertices.length; i < l; i++) {
						geometry.vertices[i].z = data[i] / 65535 * 310;
					}
				
					plane = new THREE.Mesh(geometry, material_shh);
					scene.add(plane);
					normalMatrix = new THREE.Matrix3().getNormalMatrix( plane.matrixWorld );
				});

				window.addEventListener( 'resize', onWindowResize, false );
				onWindowResize();

			}

			function onWindowResize() {

				camera.aspect = window.innerWidth / window.innerHeight;
				camera.updateProjectionMatrix();

				renderer.setSize( window.innerWidth, window.innerHeight );

			}

			function animate() {

				requestAnimationFrame( animate );

				// main scene

				renderer.setViewport( 0, 0, window.innerWidth, window.innerHeight );

				renderer.render( scene, camera );


			}

		</script>

	</body>

</html>

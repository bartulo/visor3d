<!DOCTYPE html>
<html lang="en">
	<head>
		<title>three.js webgl - lines - fat</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<script src="js/jquery-2.1.4.js"></script> 
		
		<script src="js/bootstrap.min.js"></script>
		<script src="js/threejs/three.js"></script>
		<script src="js/threejs/controls/OrbitControls.js"></script>

		<script src="js/threejs/Detector.js"></script>
		<script src='js/threejs/TerrainLoader.js'></script> 

		<script src='js/lines/LineSegmentsGeometry.js'></script>
		<script src='js/lines/LineGeometry.js'></script>
		<script src='js/lines/WireframeGeometry2.js'></script>

		<script src='js/lines/LineMaterial.js'></script>

		<script src='js/lines/LineSegments2.js'></script>
		<script src='js/lines/Line2.js'></script>
		<script src='js/lines/Wireframe.js'></script>
		<script src="js/sidebar/sidebar.js"></script>
		<script src="js/labels/labels.js"></script>
		<link rel="stylesheet" type="text/css" href="css/bootstrap.css"> 
		<link rel="stylesheet" type="text/css" href="css/main.css"> 

	</head>

	<body>

		<div id="container">

			<div class="label_container">
				<div class="label" data-coords="[ -115, 36, 48 ]">Inicio 3</div>
				<div class="label" data-coords="[ -82, -32, 57 ]">Inicio 2</div>
				<div class="label" data-coords="[ -31, -64, 65 ]">Inicio 1</div>
				<div class="label" data-coords="[ 2, 36, 58 ]">Inicio 4</div>
			</div>
					
			<ul class='tabs'>
				<li>PINTAR</li>
				<li>MEDIR</li>
				<li>ICONOS</li>
				<li>IMAGEN</li>
			</ul>
			<div id="sidebar">
				<ul class="tab_content">
					<li>
						<div class="content_wrapper">
							<h2 class="text-color">Elige un color:</h2>
						
							<ul class="colors">
								<li data-color="#00b0f0"></li>
								<li data-color="#ff0000"></li>
								<li data-color="#92d050"></li>
								<li class="active-color" data-color="#fa7e5c"></li>
								<li data-color="#000000"></li>
								<li data-color="#fab8f2"></li>
								<li data-color="#944607"></li>
							</ul>
							<div class="slide_wrapper">
								<input id="sliderColor" type="range" min="4" max="20" step="1" value="8"/>
							</div>
							<div class="lines_wrapper">
								<ul class="lines"></ul>
							</div>
							<div class="button_wrapper">
								<button type="button" class="btn btn-danger stop">Dejar de pintar</button>
							</div>
						</div>
					</li>
					
					<li>
						<div class="content_wrapper">
							<h2 class="text-color">Medir</h2>
							<div class="medicion"></div>
							<div class="button_wrapper">
								<button type="button" class="btn btn-danger stop">Dejar de medir</button>
							</div>
						</div>
					</li>
					
					<li>
						<div class="content_wrapper">
							<h2 class="text-color">Iconos</h2>
							<nav>
								<ul class="icon">
									<li data-img="camion"><a class="active"></a></li>
									<li data-img="helicoptero"><a></a></li>
									<li data-img="observador"><a></a></li>
									<li data-img="pma"><a></a></li>
									<li data-img="reten"><a></a></li>
									<li data-img="todoterreno"><a></a></li>
								</ul>
							</nav>
							<div class="icon_list_wrapper">
								<ul class="icon_list"></ul>
							</div>
							<div class="button_wrapper">
								<button type="button" class="btn btn-danger stop">Volver</button>
							</div>
						</div>
					</li>
					
					<li>
						<div class="content_wrapper">
							<h2 class="text-color">Guardar Imagen</h2>
							<div class="button_wrapper">
								<button type="button" class="btn btn-danger stop">Volver</button>
								<button type="button" class="btn" id="saveImg">Guardar Imagen</button>
							</div>
						</div>
					</li>
					
				</ul>
			</div>
		</div>
		<div id="brujula">
			<img width="200px" height=200px" id="svg" src="images/compass.svg"></img>
		</div>

		
		<script id="fragment_shh" type="x-shader/x-fragment">
			#ifdef GL_ES
			precision highp float;
			#endif

			uniform sampler2D tOne;
			uniform sampler2D tSec;

			varying vec2 vUv;
			
			void main(void)
			{
				vec3 c;
				vec4 Ca = texture2D(tOne, vUv);
				vec4 Cb = texture2D(tSec, vUv);
				c = Ca.rgb * Ca.a + Cb.rgb * Cb.a * (1.0 - Ca.a);
			    gl_FragColor= vec4(c, 1.0);
				
			}
			
		</script>
		<script id="vertex_shh" type="x-shader/x-vertex">
		
			varying vec2 vUv;
			
			void main()
			{
				vUv = uv;
				vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );
				gl_Position = projectionMatrix * mvPosition;
			}
			
		</script>

		<script>
			

			if ( ! Detector.webgl ) Detector.addGetWebGLMessage();

			var wireframe, renderer, renderer2, scene, scene2, camera, camera2, controls;
			var plane, wireframe1, geometryLine, medir, pos;
			var aspectRatio = window.innerWidth / window.innerHeight;
			var positions = [];
			var colors = [];
			var brujula_width = 200;
			var brujula_height = 200;
			var group = new THREE.Object3D();
			var iconsGroup = new THREE.Object3D();
			var a = -1;
			var b = 0;
			var camera3Active = false;
			var count = 0;
			var altitud = [];
			var alt;
			
			var labels = new THREE.Object3D();

			var lab = $('.label');
			
			// viewport

			init();
			animate();
			
			function init() {
				
				renderer = new THREE.WebGLRenderer( { antialias: true, preserveDrawingBuffer: true  } );
				renderer.setPixelRatio( window.devicePixelRatio );
				renderer.setClearColor( 0x000000, 0.0 );
				renderer.setSize( window.innerWidth, window.innerHeight );
				document.getElementById('container').appendChild( renderer.domElement );

				scene = new THREE.Scene();
				scene.add(group);
				renderLabels();
				scene.add(labels);

				camera = new THREE.PerspectiveCamera( 45, window.innerWidth / window.innerHeight, 0.1, 1000 );
				camera.position.set( 0, -90, 300 );
				camera3 = new THREE.OrthographicCamera( -150 * aspectRatio, 150 * aspectRatio, 150, -150, 0.1, 1000 );
				camera3.position.set( 0, 0, 350 );
				camera3.rotation.set( 0, 0, 0 );

				//~ ICONOS
				
				var iconElements = $('.icon > li');
				
				for ( i = 0; i < iconElements.length; i++ ) {
					
					var groupGroup = new THREE.Object3D();
					
					var iconPlusLine = new THREE.Object3D();
				
				    var spriteMap = new THREE.TextureLoader().load("images/iconos/" + iconElements[i].dataset.img + ".png");
				    
				    var spriteMaterial = new THREE.SpriteMaterial( { map: spriteMap, color: 0xffffff } );
				    
				    var sprite = new THREE.Sprite( spriteMaterial);
				    
				    sprite.scale.set( 8, 8, 8 );
			    
				    iconPlusLine.add( sprite );
				    
				    var lineMaterial = new THREE.LineBasicMaterial({
						color: 0x000000,
						linewidth: 4
					});
					
					var geometry = new THREE.Geometry();
					
					geometry.vertices.push(
						new THREE.Vector3( 0, 0, 0 ),
						new THREE.Vector3( 0, 0, -10 )
					);
					
					var line = new THREE.Line( geometry, lineMaterial );
					
					iconPlusLine.add( line );
					
					groupGroup.add( iconPlusLine );
					
					groupGroup.visible = false;
					
					iconsGroup.add( groupGroup );
				}
				
				scene.add(iconsGroup);

				controls = new THREE.OrbitControls( camera, renderer.domElement );
				controls.minDistance = 0;
				controls.maxDistance = 500;
				
				//PLANO
				
				var terrainLoader = new THREE.TerrainLoader();
				terrainLoader.load('images/mdt.bin', function(data) {

					var vertShader = document.getElementById('vertex_shh').innerHTML;
					var fragShader = document.getElementById('fragment_shh').innerHTML;
			
					var uniforms = {    // custom uniforms (your textures)

					tOne: { type: "t", value: THREE.ImageUtils.loadTexture( '') },
					tSec: { type: "t", value: THREE.ImageUtils.loadTexture( 'images/pnoa.jpg' ) }
					};
					
					var material_shh = new THREE.ShaderMaterial({
						uniforms: uniforms,
						vertexShader: vertShader,
						fragmentShader: fragShader
					});
				
					var geometry = new THREE.PlaneGeometry(300, 300, 199, 199);
			
					for (var i = 0, l = geometry.vertices.length; i < l; i++) {
						geometry.vertices[i].z = data[i] / 65535 * 310;
					}
				
					plane = new THREE.Mesh(geometry, material_shh);
					scene.add(plane);
					normalMatrix = new THREE.Matrix3().getNormalMatrix( plane.matrixWorld );
				});

				window.addEventListener( 'resize', onWindowResize, false );
				onWindowResize();

			        // BRUJULA
				//~ renderer2 = new THREE.WebGLRenderer( { alpha: true } );
				//~ renderer2.setClearColor( 0x000000, 0);
				//~ renderer2.setSize( brujula_width, brujula_height);
				//~ document.getElementById('brujula').appendChild( renderer2.domElement );
				
				//~ scene2 = new THREE.Scene();
				//~ scene2.add(new THREE.AmbientLight(0xeeeeee));
				
				//~ camera2 = new THREE.PerspectiveCamera( 50, brujula_width / brujula_height, 1, 1000 );
				//~ camera2.up = camera.up;
				
				//~ loader = new THREE.JSONLoader();
				//~ loader.load( 'flecha.json', addModel );
				
				//~ function addModel( geometry, materials ) {
					//~ var material = new THREE.MeshFaceMaterial( materials );
					//~ model = new THREE.Mesh( geometry, material );
					//~ model.scale.set(50,50,50);
					//~ model.position.set(0,0,0);
					//~ scene2.add( model );
				//~ }

			}
			
			function renderLabels() {
				for ( i = 0; i < lab.length; i++ ) {
					var label = new THREE.Object3D();
					var coords = $(lab[i]).data('coords');
				
					var queryMarker = new THREE.Mesh(new THREE.SphereGeometry(.5),
								new THREE.MeshBasicMaterial({
										color: 0x990000
								}));
					queryMarker.scale.set(2,2,2);
					queryMarker.position.set( coords[0], coords[1], coords[2] );
					label.add(queryMarker);
					
					// CONNECTOR
					
					var geomConn = new THREE.Geometry();
					var pto1 = new THREE.Vector3( coords[0], coords[1], coords[2] );
					var pto2 = new THREE.Vector3( coords[0], coords[1], coords[2] + 10 );
					geomConn.vertices.push(pto1, pto2);
					matConn = new THREE.LineBasicMaterial();
					conn = new THREE.Line(geomConn, matConn);
					label.add(conn);
					labels.add(label);
					console.log(labels);
				}
			}

			function onWindowResize() {
				
				aspectRatio = window.innerWidth / window.innerHeight;

				camera.aspect = aspectRatio;
				camera.updateProjectionMatrix();
				
				camera3.left = -150 * aspectRatio;
				camera3.right = 150 * aspectRatio;
				camera3.updateProjectionMatrix();


				renderer.setSize( window.innerWidth, window.innerHeight );

			}

			function animate() {

				requestAnimationFrame( animate );
				
				$('#svg')[0].style.transform = 'rotate(' + camera.rotation._z + 'rad)';

				// main scene

				renderer.setViewport( 0, 0, window.innerWidth, window.innerHeight );

				if ( camera3Active === false ) {

					renderer.render( scene, camera );

				} else {
					
					renderer.render( scene, camera3 );

				}
				
				updateLabel();

				//~ renderer2.render(scene2, camera2);

				//~ camera2.position.copy( camera.position );
				//~ camera2.position.sub( controls.target );
				//~ camera2.position.setLength( 200 );
				//~ camera2.lookAt( scene2.position );
				
			}

		</script>

	</body>

</html>

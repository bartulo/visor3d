<!DOCTYPE html>
<html lang="en">
	<head>
		<title>three.js webgl - lines - fat</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<script src="js/jquery-2.1.4.js"></script> 
		
		<script src="js/bootstrap.min.js"></script>
		<script src="js/threejs/three.js"></script>
		<script src="js/threejs/controls/OrbitControls.js"></script>

		<script src="js/threejs/Detector.js"></script>
		<script src='js/threejs/TerrainLoader.js'></script> 

		<script src='js/lines/LineSegmentsGeometry.js'></script>
		<script src='js/lines/LineGeometry.js'></script>
		<script src='js/lines/WireframeGeometry2.js'></script>

		<script src='js/lines/LineMaterial.js'></script>

		<script src='js/lines/LineSegments2.js'></script>
		<script src='js/lines/Line2.js'></script>
		<script src='js/lines/Wireframe.js'></script>
		<script src="js/sidebar/sidebar.js"></script>
		<link rel="stylesheet" type="text/css" href="css/bootstrap.css"> 
		<link rel="stylesheet" type="text/css" href="css/main.css"> 

	</head>

	<body>

		<div id="container">
			<ul class='tabs'>
				<li>PINTAR</li>
				<li>MEDIR</li>
				<li>ICONOS</li>
				<li>IMAGEN</li>
			</ul>
			<div id="sidebar">
				<ul class="tab_content">
					<li>
						<div class="content_wrapper">
							<h2 class="text-color">Elige un color:</h2>
						
							<ul class="colors">
								<li data-color="#00b0f0"></li>
								<li data-color="#ff0000"></li>
								<li data-color="#92d050"></li>
								<li class="active-color" data-color="#fa7e5c"></li>
								<li data-color="#000000"></li>
								<li data-color="#fab8f2"></li>
								<li data-color="#944607"></li>
							</ul>
							<div class="slide_wrapper">
								<input id="sliderColor" type="range" min="4" max="20" step="1" value="8"/>
							</div>
							<div class="lines_wrapper">
								<ul class="lines"></ul>
							</div>
							<div class="button_wrapper">
								<button type="button" class="btn btn-danger stop">Dejar de pintar</button>
							</div>
						</div>
					</li>
					
					<li>
						<div class="content_wrapper">
							<h2 class="text-color">Medir</h2>
							<div class="medicion"></div>
							<div class="button_wrapper">
								<button type="button" class="btn btn-danger stop">Dejar de medir</button>
							</div>
						</div>
					</li>
					
					<li>
						<div class="content_wrapper">
							<h2 class="text-color">Iconos</h2>
							<nav>
								<ul class="icon">
									<li data-img="camion"><a class="active"></a></li>
									<li data-img="helicoptero"><a></a></li>
									<li data-img="observador"><a></a></li>
									<li data-img="pma"><a></a></li>
									<li data-img="reten"><a></a></li>
									<li data-img="todoterreno"><a></a></li>
								</ul>
							</nav>
							<div class="icon_list_wrapper">
								<ul class="icon_list"></ul>
							</div>
							<div class="button_wrapper">
								<button type="button" class="btn btn-danger stop">Volver</button>
							</div>
						</div>
					</li>
					
					<li>
						<div class="content_wrapper">
							<h2 class="text-color">Guardar Imagen</h2>
							<div class="button_wrapper">
								<button type="button" class="btn btn-danger stop">Volver</button>
								<button type="button" class="btn" id="saveImg">Guardar Imagen</button>
							</div>
						</div>
					</li>
					
				</ul>
			</div>
		</div>
		<div id="brujula"></div>

		
		<script id="fragment_shh" type="x-shader/x-fragment">
			#ifdef GL_ES
			precision highp float;
			#endif

			uniform sampler2D tOne;
			uniform sampler2D tSec;

			varying vec2 vUv;
			
			void main(void)
			{
				vec3 c;
				vec4 Ca = texture2D(tOne, vUv);
				vec4 Cb = texture2D(tSec, vUv);
				c = Ca.rgb * Ca.a + Cb.rgb * Cb.a * (1.0 - Ca.a);
			    gl_FragColor= vec4(c, 1.0);
				
			}
			
		</script>
		<script id="vertex_shh" type="x-shader/x-vertex">
		
			varying vec2 vUv;
			
			void main()
			{
				vUv = uv;
				vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );
				gl_Position = projectionMatrix * mvPosition;
			}
			
		</script>

		<script>
			

			if ( ! Detector.webgl ) Detector.addGetWebGLMessage();

			var wireframe, renderer, renderer2, scene, scene2, camera, camera2, controls;
			var plane, wireframe1, geometryLine, medir, pos;
			var positions = [];
			var colors = [];
			var brujula_width = 200;
			var brujula_height = 200;
			var group = new THREE.Object3D();
			var iconsGroup = new THREE.Object3D();
			var a = -1;
			var b = 0;
			var count = 0;
			var altitud = [];
			var alt;
			
			// viewport

			init();
			animate();
			
			function init() {

				renderer = new THREE.WebGLRenderer( { antialias: true, preserveDrawingBuffer: true  } );
				renderer.setPixelRatio( window.devicePixelRatio );
				renderer.setClearColor( 0x000000, 0.0 );
				renderer.setSize( window.innerWidth, window.innerHeight );
				document.getElementById('container').appendChild( renderer.domElement );

				scene = new THREE.Scene();
				scene.add(group);

				camera = new THREE.PerspectiveCamera( 45, window.innerWidth / window.innerHeight, 0.1, 1000 );
				camera.position.set( 0, -90, 200 );

				//~ ICONOS
				
				var iconElements = $('.icon > li');
				
				for ( i = 0; i < iconElements.length; i++ ) {
					
					var groupGroup = new THREE.Object3D();
					
					var iconPlusLine = new THREE.Object3D();
				
				    var spriteMap = new THREE.TextureLoader().load("images/iconos/" + iconElements[i].dataset.img + ".png");
				    
				    var spriteMaterial = new THREE.SpriteMaterial( { map: spriteMap, color: 0xffffff } );
				    
				    var sprite = new THREE.Sprite( spriteMaterial);
				    
				    sprite.scale.set( 6, 6, 6);
			    
				    iconPlusLine.add( sprite );
				    
				    var lineMaterial = new THREE.LineBasicMaterial({
						color: 0x000000,
						linewidth: 4
					});
					
					var geometry = new THREE.Geometry();
					
					geometry.vertices.push(
						new THREE.Vector3( 0, 0, 0 ),
						new THREE.Vector3( 0, 0, -10 )
					);
					
					var line = new THREE.Line( geometry, lineMaterial );
					
					iconPlusLine.add( line );
					
					groupGroup.add( iconPlusLine );
					
					groupGroup.visible = false;
					
					iconsGroup.add( groupGroup );
				}
				
				scene.add(iconsGroup);

				controls = new THREE.OrbitControls( camera, renderer.domElement );
				controls.minDistance = 0;
				controls.maxDistance = 500;
				
				//PLANO
				
				var terrainLoader = new THREE.TerrainLoader();
				terrainLoader.load('images/mdt.bin', function(data) {

					var vertShader = document.getElementById('vertex_shh').innerHTML;
					var fragShader = document.getElementById('fragment_shh').innerHTML;
			
					var uniforms = {    // custom uniforms (your textures)

					tOne: { type: "t", value: THREE.ImageUtils.loadTexture( 'images/E2.png') },
					tSec: { type: "t", value: THREE.ImageUtils.loadTexture( 'images/pnoa.jpg' ) }
					};
					
					var material_shh = new THREE.ShaderMaterial({
						uniforms: uniforms,
						vertexShader: vertShader,
						fragmentShader: fragShader
					});
				
					var geometry = new THREE.PlaneGeometry(300, 300, 199, 199);
			
					for (var i = 0, l = geometry.vertices.length; i < l; i++) {
						geometry.vertices[i].z = data[i] / 65535 * 310;
					}
				
					plane = new THREE.Mesh(geometry, material_shh);
					scene.add(plane);
					normalMatrix = new THREE.Matrix3().getNormalMatrix( plane.matrixWorld );
				});

				window.addEventListener( 'resize', onWindowResize, false );
				onWindowResize();

			        // BRUJULA
				renderer2 = new THREE.WebGLRenderer( { alpha: true } );
				renderer2.setClearColor( 0x000000, 0);
				renderer2.setSize( brujula_width, brujula_height);
				document.getElementById('brujula').appendChild( renderer2.domElement );
				
				scene2 = new THREE.Scene();
				scene2.add(new THREE.AmbientLight(0xeeeeee));
				
				camera2 = new THREE.PerspectiveCamera( 50, brujula_width / brujula_height, 1, 1000 );
				camera2.up = camera.up;
				
				loader = new THREE.JSONLoader();
				loader.load( 'flecha.json', addModel );
				
				function addModel( geometry, materials ) {
					var material = new THREE.MeshFaceMaterial( materials );
					model = new THREE.Mesh( geometry, material );
					model.scale.set(50,50,50);
					model.position.set(0,0,0);
					scene2.add( model );
				}

			}
			

			function onWindowResize() {

				camera.aspect = window.innerWidth / window.innerHeight;
				camera.updateProjectionMatrix();

				renderer.setSize( window.innerWidth, window.innerHeight );

			}

			function animate() {

				requestAnimationFrame( animate );

				// main scene

				renderer.setViewport( 0, 0, window.innerWidth, window.innerHeight );

				renderer.render( scene, camera );

				renderer2.render(scene2, camera2);
				
				camera2.position.copy( camera.position );
				camera2.position.sub( controls.target );
				camera2.position.setLength( 200 );
				camera2.lookAt( scene2.position );
				
			}

		</script>

	</body>

</html>
